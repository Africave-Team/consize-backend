version: 2.1

jobs:
  build_and_deploy:
    docker:
      - image: circleci/node:14

    steps:
      - checkout
      # SSH into the server
      - run:
          name: Create .ssh directory
          command: mkdir -p ~/.ssh
      - run:
          name: Add server fingerprint
          command: echo '${SERVER_ADDRESS} ${SSH_PUBLIC_KEY}' >> ~/.ssh/known_hosts
      - run:
          name: SSH into the server
          command: ssh ${SSH_USERNAME}@${SERVER_ADDRESS}

      # Pull the latest changes from Git
      - run:
          name: Pull latest changes from Git
          command: |
            cd /consize-backend
            git checkout main
            git pull

      # Run the build command
      - run:
          name: Run build command
          command: |
            npm install
            npm run start:build
workflows:
  build_and_deploy_work:
    jobs:
      - build_and_deploy
